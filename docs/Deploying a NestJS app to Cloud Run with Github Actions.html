<!DOCTYPE html>
<!-- saved from url=(0088)https://www.tomray.dev/deploy-nestjs-cloud-run#automated-deployments-with-github-actions -->
<html lang="en" class="scroll-smooth"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');d.add('light');if("system"===e||(!e&&false)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"><script defer="" type="text/javascript" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/pirsch.js" id="pirschjs" data-code="iiogwINu4SXHieTZaBadx5hzS79NCCUa"></script><title>Deploying a NestJS app to Cloud Run with Github Actions</title><meta name="robots" content="follow, index"><meta name="description" content="Learn how to deploy a NestJs app with continuous deployments to Cloud Run using Github Actions and Cloud Build"><meta property="og:url" content="https://www.tomray.dev/deploy-nestjs-cloud-run"><meta property="og:type" content="article"><meta property="og:site_name" content="Tom Ray - Learn NestJS Best Practices"><meta property="og:description" content="Learn how to deploy a NestJs app with continuous deployments to Cloud Run using Github Actions and Cloud Build"><meta property="og:title" content="Deploying a NestJS app to Cloud Run with Github Actions"><meta property="og:image" content="https://www.tomray.dev/static/images/deploy-nestjs-cloud-run/nest-cloud-run.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="https://twitter.com/bytomray"><meta name="twitter:title" content="Deploying a NestJS app to Cloud Run with Github Actions"><meta name="twitter:description" content="Learn how to deploy a NestJs app with continuous deployments to Cloud Run using Github Actions and Cloud Build"><meta name="twitter:image" content="https://www.tomray.dev/static/images/deploy-nestjs-cloud-run/nest-cloud-run.png"><link rel="canonical" href="https://www.tomray.dev/deploy-nestjs-cloud-run"><meta property="article:published_time" content="2022-05-29T00:00:00.000Z"><meta property="article:modified_time" content="2022-05-29T00:00:00.000Z"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.tomray.dev/deploy-nestjs-cloud-run"
  },
  "headline": "Deploying a NestJS app to Cloud Run with Github Actions",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://www.tomray.dev/static/images/deploy-nestjs-cloud-run/nest-cloud-run.png"
    }
  ],
  "datePublished": "2022-05-29T00:00:00.000Z",
  "dateModified": "2022-05-29T00:00:00.000Z",
  "author": {
    "@type": "Person",
    "name": "Tom Ray"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Tom Ray",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.tomray.dev/static/images/profile.jpg"
    }
  },
  "description": "Learn how to deploy a NestJs app with continuous deployments to Cloud Run using Github Actions and Cloud Build"
}</script><meta name="next-head-count" content="22"><link rel="apple-touch-icon" sizes="76x76" href="https://www.tomray.dev/static/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://www.tomray.dev/static/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://www.tomray.dev/static/favicons/favicon-16x16.png"><link rel="manifest" href="https://www.tomray.dev/static/favicons/site.webmanifest"><link rel="mask-icon" href="https://www.tomray.dev/static/favicons/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#000000"><meta name="theme-color" content="#000000"><link rel="alternate" type="application/rss+xml" href="https://www.tomray.dev/feed.xml"><link rel="preload" href="./Deploying a NestJS app to Cloud Run with Github Actions_files/ffc5a27889568033.css" as="style"><link rel="stylesheet" href="./Deploying a NestJS app to Cloud Run with Github Actions_files/ffc5a27889568033.css" data-n-g=""><noscript data-n-css=""></noscript><script defer="" nomodule="" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/polyfills-5cd94c89d3acac5f.js"></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/webpack-2fc02e0bcaf17951.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/main-4b3303258e2675ad.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/_app-03861b6aa7d80080.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/247-1075fb68086b7538.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/104-8e6ea5b85c15c60e.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/[...slug]-4c5b5c70a0dd0d67.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/_buildManifest.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/_ssgManifest.js" defer=""></script><script src="./Deploying a NestJS app to Cloud Run with Github Actions_files/_middlewareManifest.js" defer=""></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Deploying a NestJS app to Cloud Run with Github Actions_files/m=el_main_css"></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 lg:max-w-5xl xl:px-0"><div class="mx-auto flex h-screen max-w-5xl flex-col justify-between"><header class="flex items-center justify-between py-4"><div><a aria-label="Tom Ray" href="https://www.tomray.dev/"><div class="flex items-center py-4 pr-6 text-xl font-bold text-gray-700 hover:text-gray-900 dark:text-white"><img src="./Deploying a NestJS app to Cloud Run with Github Actions_files/profile.jpg" alt="Tom Ray" class="mr-2 h-8 w-8 rounded-full"><span>Tom Ray</span></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class=" text-midnight p-1 font-normal dark:text-gray-100 sm:p-4" href="https://www.tomray.dev/">Blog</a><a class=" text-midnight p-1 font-normal dark:text-gray-100 sm:p-4" href="https://www.tomray.dev/nestjs-course">NestJS Course</a><a class=" text-midnight p-1 font-normal dark:text-gray-100 sm:p-4" href="https://www.tomray.dev/about">About</a></div><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-24 right-0 z-10 h-full w-full transform bg-gray-100 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed h-full w-full cursor-auto focus:outline-none"></button><nav class="fixed mt-2 h-full"><div class="p-4"><a class="text-2xl font-bold text-gray-900 dark:text-gray-100" href="https://www.tomray.dev/">Blog</a></div><div class="p-4"><a class="text-2xl font-bold text-gray-900 dark:text-gray-100" href="https://www.tomray.dev/nestjs-course">NestJS Course</a></div><div class="p-4"><a class="text-2xl font-bold text-gray-900 dark:text-gray-100" href="https://www.tomray.dev/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article class="mx-auto"><div><div class="pb-8 " style="grid-template-rows:auto 1fr"><div class="xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="lg:flex"><div class="prose mx-auto max-w-2xl pt-6 pb-8 dark:prose-dark"><header class="mb-8"><dl><div><dt class="sr-only">Published on</dt><dd class="text-normal mb-2 leading-6 text-gray-500 dark:text-gray-400">Last updated: <time datetime="2022-05-29">May 29, 2022</time></dd></div></dl><h1 class="mb-4 text-left text-4xl text-gray-900 sm:text-5xl sm:font-extrabold">Deploying a NestJS app to Cloud Run with Github Actions</h1></header><div><p>This is a quick start guide to deploying a NestJs project to <a target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/run">Cloud Run</a>.</p><p>We'll first setup the deployment manually, then move to an automated CD (continuous deployment) workflow using Github Actions.</p><p>Ready? Let's dive in ðŸ¤¿.</p><p>Here's the <a target="_blank" rel="noopener noreferrer" href="https://github.com/tomwray13/nest-cloud-run">Github repository</a> if you'd like to review the code.</p><div class="polka my-8 flex flex-col items-center rounded-md p-6 sm:flex-row sm:items-start "><img src="./Deploying a NestJS app to Cloud Run with Github Actions_files/nestjs.png" alt="NestJS logo" class="mt-0 mb-4 h-20 sm:mr-6 sm:h-20"><div><span class="mb-1 inline-block text-xl font-bold dark:text-gray-800">Free NestJS Course</span><span class="flex flex-col dark:text-gray-800">Want to use NestJS to it's full potential and understand how it really works? Check out my free course which covers concepts like Dependency Injection, IoC Containers and more:</span><form class="mt-4 grid w-full max-w-lg grid-cols-8 items-end text-sm"><div class="mb-2 col-span-8 mr-1 sm:col-span-5 sm:mb-0 sm:mr-2"><label class="mb-2 block text-left font-semibold" for="magnet">Your email address</label><input type="email" name="magnet" id="magnet" class="w-full rounded-md text-sm text-gray-800 focus:ring-primary-500" placeholder="e.g. johnsmith@gmail.com" value="" required=""></div><button type="submit" class="rounded-md border border-green-500 bg-green-500 px-4 py-2 font-bold text-white col-span-8 sm:col-span-3 ">Get free course</button></form></div></div><details open="" class="lg:hidden"><summary class="ml-6 pt-2 pb-2 text-xl font-bold">Table of Contents</summary><div class="ml-6"><ul><li class="false"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#prerequisites">Prerequisites</a></li><li class="false"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#start-a-nestjs-project">Start a NestJS project</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#configure-a-port-environment-variable">Configure a PORT environment variable</a></li><li class="false"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#prepare-the-docker-image">Prepare the Docker image</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#test-the-container-locally">Test the container locally</a></li><li class="false"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#manually-deploying-to-cloud-run">Manually deploying to Cloud Run</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#check-your-gcloud-cli-project-is-set">Check your gcloud CLI project is set</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#use-gcloud-run-deploy">Use gcloud run deploy</a></li><li class="false"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#automated-deployments-with-github-actions">Automated deployments with Github Actions</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#enable-google-cloud-apis">Enable Google Cloud APIs</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#create-a-service-account-with-permissions">Create a service account with permissions</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#configure-workflow-identity-federation">Configure Workflow Identity Federation</a></li><li class="ml-6"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#add-github-action">Add Github Action</a></li><li class="false"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#conclusion">Conclusion</a></li></ul></div></details><h2 id="prerequisites"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#prerequisites" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Prerequisites</h2><ul><li>Your Nest project is a Github repository. This allows us to setup continuous deployment with Github Actions.</li><li>Docker installed on your machine</li><li>A project setup in Google Cloud Platform</li><li>Have the <a target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/sdk/docs/install">gcloud CLI</a> installed on your machine</li></ul><h2 id="start-a-nestjs-project"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#start-a-nestjs-project" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Start a NestJS project</h2><p>Incase you don't have a NestJS project setup already, set one up with the Nest CLI:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">$ <span class="token function">npm</span> i -g @nestjs/cli
</span><span class="code-line">$ nest new project-name
</span></code></pre></div><p>Follow the prompts to setup your project.</p><h3 id="configure-a-port-environment-variable"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#configure-a-port-environment-variable" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Configure a PORT environment variable</h3><p>Cloud Run will automatically inject the <code>PORT</code> number, so you'll need to edit the default bootstrap function which starts the server.</p><p>Here's the default:</p><div class="relative"><pre><code class="code-highlight language-ts"><span class="code-line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>You'll need to update this to the following:</p><div class="relative"><pre><code class="code-highlight language-ts"><span class="code-line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div><p>Now locally if you don't have a port variable set in your env file, it will default to 3000.</p><p>If, however, you try testing this locally by using a custom <code>PORT</code> environment variable and starting up your local server, you'll notice it doesn't work.</p><p>That's because in order to use environment variables in NestJS you need to make the <code>.env</code> file accessible.</p><p>To do that "the Nest way", install the required dependency:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line"><span class="token function">npm</span> i --save @nestjs/config
</span></code></pre></div><p>Then use the package in the root <code>AppModule</code>:</p><div class="remark-code-title">app.module.ts</div><div class="relative"><pre><code class="code-highlight language-ts"><span class="code-line"><span class="token operator">...</span>
</span><span class="code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/config'</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token decorator"><span class="token operator at">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  imports<span class="token operator">:</span> <span class="token punctuation">[</span>ConfigModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token operator">...</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span></code></pre></div><p>You can now set a custom <code>PORT</code> value in your env file and test it locally to check that it's working.</p><p>Cloud Run will take care of the port for you on production, so you don't need to manually set a <code>PORT</code> env variable in your Cloud Run secrets.</p><p>For a more detailed look at working with environment variables in NestJS, check out <a href="https://www.tomray.dev/nestjs-config">this tutorial</a>.</p><h2 id="prepare-the-docker-image"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#prepare-the-docker-image" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Prepare the Docker image</h2><p>In order to deploy to Cloud Run, you need a container image.</p><p>A container image is an isolated package of software that includes everything you need to run the code. You can define container images by writing a <code>Dockerfile</code> which provides the instructions on how to build the image.</p><p>This tutorial won't go into the details of <a href="https://www.tomray.dev/nestjs-docker-production">how to write a production optimized Dockerfile for NestJS apps</a>, however, here's a Dockerfile set up to achieve just that:</p><div class="remark-code-title">Dockerfile</div><div class="relative"><pre><code class="code-highlight language-Dockerfile"><span class="code-line"><span class="token comment">###################</span>
</span><span class="code-line"><span class="token comment"># BUILD FOR LOCAL DEVELOPMENT</span>
</span><span class="code-line"><span class="token comment">###################</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">As</span> development</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Create app directory</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy application dependency manifests to the container image.</span>
</span><span class="code-line"><span class="token comment"># A wildcard is used to ensure copying both package.json AND package-lock.json (when available).</span>
</span><span class="code-line"><span class="token comment"># Copying this first prevents re-running npm install on every code change.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> package*.json ./</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Install app dependencies using the `npm ci` command instead of `npm install`</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> npm ci</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Bundle app source</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Use the node user from the image (instead of the root user)</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">###################</span>
</span><span class="code-line"><span class="token comment"># BUILD FOR PRODUCTION</span>
</span><span class="code-line"><span class="token comment">###################</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">As</span> build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> package*.json ./</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># In order to run `npm run build` we need access to the Nest CLI which is a dev dependency. In the previous development stage we ran `npm ci` which installed all dependencies, so we can copy over the node_modules directory from the development image</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">development</span></span> /usr/src/app/node_modules ./node_modules</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Run the build command which creates the production bundle</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> npm run build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set NODE_ENV environment variable</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Running `npm ci` removes the existing node_modules directory and passing in --only=production ensures that only the production dependencies are installed. This ensures that the node_modules directory is as optimized as possible</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> npm ci --only=production &amp;&amp; npm cache clean --force</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">###################</span>
</span><span class="code-line"><span class="token comment"># PRODUCTION</span>
</span><span class="code-line"><span class="token comment">###################</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">As</span> production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy the bundled code from the build stage to the production image</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /usr/src/app/node_modules ./node_modules</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /usr/src/app/dist ./dist</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Start the server using the production build</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">CMD</span> [ <span class="token string">"node"</span>, <span class="token string">"dist/main.js"</span> ]</span>
</span><span class="code-line">
</span></code></pre></div><p>Similar to a <code>.gitignore</code> file, we can add a <code>.dockerignore</code> file which will prevent certain files from being included in the image build.</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line"><span class="token function">touch</span> .dockerignore
</span></code></pre></div><p>Then exclude the following files from the image build:</p><div class="remark-code-title">.dockerignore</div><div class="relative"><pre><code class="code-highlight"><span class="code-line">Dockerfile
</span><span class="code-line">.dockerignore
</span><span class="code-line">node_modules
</span><span class="code-line">npm-debug.log
</span><span class="code-line">dist
</span></code></pre></div><h3 id="test-the-container-locally"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#test-the-container-locally" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Test the container locally</h3><p>Before pushing this up to Cloud Run, let's now do some testing locally to check if the Dockerfile behaves as we expect.</p><p>Let's first build the image using the command in your terminal at the root of your project (you can swap out <code>nest-cloud-run</code> with your project name). Don't forget the <code>.</code>!</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line"><span class="token function">docker</span> build -t nest-cloud-run <span class="token class-name builtin">.</span>
</span></code></pre></div><p>You can verify the image has been created by running <code>docker images</code> which will output a list of Docker images you have on your local machine:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line"><span class="token function">docker</span> images
</span><span class="code-line">REPOSITORY                   TAG       IMAGE ID       CREATED          SIZE
</span><span class="code-line">nest-cloud-run               latest    004f7f222139   <span class="token number">31</span> seconds ago   114MB
</span></code></pre></div><p>Let's now start the container and run the image with this command (be sure to same image name used above):</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line"><span class="token function">docker</span> run -p80:3000 nest-cloud-run
</span></code></pre></div><p>You can now access the NestJS app by visiting <code>http://localhost</code> in your browser (just <code>http://localhost</code> without any port numbers).</p><h2 id="manually-deploying-to-cloud-run"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#manually-deploying-to-cloud-run" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Manually deploying to Cloud Run</h2><p>Before setting up automated deployments when changes are pushed to your Git repo, let's first do a manual deployment using the gcloud CLI.</p><p>Doing a manual deployment via the gcloud CLI will setup the Cloud Run service for us rather than needing to manually create inside the GCP console.</p><h3 id="check-your-gcloud-cli-project-is-set"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#check-your-gcloud-cli-project-is-set" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Check your gcloud CLI project is set</h3><p>You might have multiple accounts and projects in your GCP account, so you'll want to make sure you create the Cloud Run service in the right one.</p><p>First you can check the current active project the gcloud CLI is using by running:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">gcloud config get-value project
</span></code></pre></div><p>If that command returns the ID of the project you want to create the Cloud Run service in, great! Skip down to the next section. Otherwise, follow the next steps:</p><p>Make sure you're authenticated into the correct account:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">gcloud auth list
</span><span class="code-line">* account <span class="token number">1</span>
</span><span class="code-line">  account <span class="token number">2</span>
</span></code></pre></div><p>You need to be authenticated in the account where your project lives, so change account if necessary with:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">gcloud config <span class="token class-name builtin">set</span> account <span class="token variable"><span class="token variable">`</span>ACCOUNT<span class="token variable">`</span></span>
</span></code></pre></div><p>List out the projects in the account your authenticated in:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">gcloud projects list
</span></code></pre></div><p>And finally, switch to the intended project:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">gcloud config <span class="token class-name builtin">set</span> project <span class="token variable"><span class="token variable">`</span>PROJECT ID<span class="token variable">`</span></span>
</span></code></pre></div><h3 id="use-gcloud-run-deploy"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#use-gcloud-run-deploy" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Use gcloud run deploy</h3><p>We're now going to use the <code>gcloud run deploy</code> command which feels a bit like magic - so let's breakdown what happens behind the scenes:</p><ul><li>Uses Cloud Build to build the container image (using the <code>Dockerfile</code> as instructions)</li><li>The container is stored in Artifact Registry</li><li>Creates a service in Cloud Run against the container image</li></ul><p>For this step, you can either follow the <a target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy/deploy-nodejs-service">Cloud Run docs</a> (recommended) or follow the steps below.</p><p>Run the following command in your terminal at the root of your project:</p><div class="relative"><pre><code class="language-shell code-highlight"><span class="code-line">gcloud run deploy
</span></code></pre></div><p>If prompted to enable the API, Reply <code>y</code> to enable.</p><ol><li>When you are prompted for the source code location, press Enter to deploy the current folder.</li><li>When you are prompted for the service name, press Enter to accept the default name.</li><li>If you are prompted to enable the Artifact Registry API, respond by pressing y.</li><li>When you are prompted for region: select the region of your choice, for example, us-central1.</li><li>You will be prompted to allow unauthenticated invocations: respond y .</li></ol><p>Then wait a few moments until the deployment is complete. On success, the command line displays the service URL.</p><p>Visit your deployed service by opening the service URL in a web browser.</p><div class="polka my-8 flex flex-col items-center rounded-md p-6 sm:flex-row sm:items-start "><img src="./Deploying a NestJS app to Cloud Run with Github Actions_files/nestjs.png" alt="NestJS logo" class="mt-0 mb-4 h-20 sm:mr-6 sm:h-20"><div><span class="mb-1 inline-block text-xl font-bold dark:text-gray-800">Free NestJS Course</span><span class="flex flex-col dark:text-gray-800">Want to use NestJS to it's full potential and understand how it really works? Check out my free course which covers concepts like Dependency Injection, IoC Containers and more:</span><form class="mt-4 grid w-full max-w-lg grid-cols-8 items-end text-sm"><div class="mb-2 col-span-8 mr-1 sm:col-span-5 sm:mb-0 sm:mr-2"><label class="mb-2 block text-left font-semibold" for="magnet">Your email address</label><input type="email" name="magnet" id="magnet" class="w-full rounded-md text-sm text-gray-800 focus:ring-primary-500" placeholder="e.g. johnsmith@gmail.com" value="" required=""></div><button type="submit" class="rounded-md border border-green-500 bg-green-500 px-4 py-2 font-bold text-white col-span-8 sm:col-span-3 ">Get free course</button></form></div></div><h2 id="automated-deployments-with-github-actions"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#automated-deployments-with-github-actions" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Automated deployments with Github Actions</h2><p>Okay, let's setup some automation with Github Actions!</p><h3 id="enable-google-cloud-apis"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#enable-google-cloud-apis" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Enable Google Cloud APIs</h3><p>Before proceeding, make sure the following are enabled inside your Google Cloud Platform account:</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://console.cloud.google.com/marketplace/product/google/run.googleapis.com">Cloud Run API</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://console.cloud.google.com/marketplace/product/google/cloudbuild.googleapis.com">Cloud Build API</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://console.cloud.google.com/marketplace/product/google/artifactregistry.googleapis.com">Artifact Registry API</a></li></ul><p>Just click the above 3 links and ensure you've pressed the 'Enable' button on each.</p><h3 id="create-a-service-account-with-permissions"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#create-a-service-account-with-permissions" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Create a service account with permissions</h3><p>We're going to do the next couple of steps inside the GCP console rather than via the gcloud CLI - I'm a more visual dude so that's what I prefer!</p><p>As we're setting up the deployments to Cloud Run in a 3rd party environment (Github), we need a way of giving access to Github to run the deployment.</p><p>That's where service accounts come in.</p><p>A service account allows 'non-human' users to interact with Google APIs - exactly what we need to work with Github.</p><p>So if you first go to create a service account:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27620%27/%3e"></span><img alt="Create service account" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Create service account" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fcreate-service-account.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fcreate-service-account.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/create-service-account.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>And then add the service account details (something like 'Github Action' makes sense):</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27636%27/%3e"></span><img alt="Service account name" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Service account name" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-name.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-name.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/service-account-name.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>Then in the next step. grant the following roles:</p><ul><li>Cloud Run Admin</li><li>Cloud Run Service Agent</li><li>Cloud Build Editor</li><li>Storage Admin</li><li>Artifact Registry Administrator</li></ul><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27854%27/%3e"></span><img alt="Service account permissions" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Service account permissions" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-permissions.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-permissions.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/service-account-permissions.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>You can skip the final step where it prompts you to grant users access to this service account.</p><h3 id="configure-workflow-identity-federation"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#configure-workflow-identity-federation" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Configure Workflow Identity Federation</h3><p>The Github Action we're going to setup in the next step has essentially 2 steps:</p><ol><li>Authenticate the service account to make deployments to your Cloud Run project</li><li>Deploy your application to Cloud Run (this step takes care of building the image, too)</li></ol><p>For the authentication step, you can either use Workflow Identity or use a credentials JSON file. Google recommends Workflow Identity so that's what we're going to setup now.</p><p>Head to Workload Identity Federation and press the 'Create Pool' button:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27706%27/%3e"></span><img alt="Create workload identity pool" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Create workload identity pool" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fcreate-workload-pool.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fcreate-workload-pool.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/create-workload-pool.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>Give your identity pool a name like 'Github Auth':</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27817%27/%3e"></span><img alt="Workload identity name" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Workload identity name" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-pool-name.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-pool-name.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-pool-name.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>In the next step for adding a provider to pool, set the following:</p><ul><li>Choose OpenID Connect (OIDC) in the 'Select a provider' dropdown</li><li>Define a provider name (e.g. Github Action)</li><li>Define a provider ID (e.g. github-action). This might be set automatically for you.</li><li>For the issuer URL, use <code>https://token.actions.githubusercontent.com</code></li><li>Leave the audience set to 'Default audience'</li></ul><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27906%27/%3e"></span><img alt="Add workload identity provider" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Add workload identity provider" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-provider.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>In the next step, add the following 3 provider attributes:</p><ul><li>google-subject = <code>assertion.sub</code></li><li>attribute.actor = <code>assertion.actor</code></li><li>attribute.repository = <code>assertion.repository</code></li></ul><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27891%27/%3e"></span><img alt="Set workload identity provider attributes" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Set workload identity provider attributes" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider-attributes.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider-attributes.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-provider-attributes.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>Then hit the save button.</p><p>Copy the IAM principal value of the pool to your clipboard. We'll need this in an upcoming step.</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271440%27%20height=%27966%27/%3e"></span><img alt="IAM principal value" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="IAM principal value" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-pool-id.png&amp;w=1920&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-pool-id.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-pool-id.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>The final step is to connect the service account we created in the previous step to the Pool we just created.</p><p>To do that, head to the Service Accounts page and go into the service account you created in the previous step:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27706%27/%3e"></span><img alt="List of GCP service accounts" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="List of GCP service accounts" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/service-account.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>From there, go into the Permissions tab and press the 'Grant Access' button to add a new principal with a role-specific to our pool.</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27771%27/%3e"></span><img alt="Grant new IAM principal" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Grant new IAM principal" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-add-permissions.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-add-permissions.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/service-account-add-permissions.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>For the 'New principal' field, you'll want to append 2 strings together:</p><ul><li>The IAM principal value you copied to your clipboard above</li><li>And <code>/attribute.repository/${REPO}</code> (You'll want to replace <code>${REPO}</code> with your Github repo using the format <code>username/repo</code>. For example, mine would be <code>tomwray13/nest-cloud-run</code>)</li></ul><p>Together, mine looks like this:</p><p><code>principalSet://iam.googleapis.com/projects/84230984908/locations/global/workloadIdentityPools/github-auth/attribute.repository/tomwray13/nest-cloud-run</code></p><p>Use this string in the 'New principal' field and set the role as Workload Identity User:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27755%27/%3e"></span><img alt="Add new IAM principal" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Add new IAM principal" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-add-principal.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account-add-principal.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/service-account-add-principal.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>And that's it! Now to building our Github Action.</p><h3 id="add-github-action"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#add-github-action" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Add Github Action</h3><p>Let's first go to the 'Actions' tab in your Github repo and search for <code>cloud run</code>. Press the configure button on the 'Deploy to Cloud Run from source' workflow:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27644%27/%3e"></span><img alt="Github Action search" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Github Action search" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fgithub-actions-cloud-run.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fgithub-actions-cloud-run.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/github-actions-cloud-run.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>This is the official workflow written by the GCP team and what we'll be using to build our Github Action.</p><p>There are some helpful comments in the workflow which explain the setup required. We've already covered this setup in the previous steps, but it's worth reading to ensure everything is setup correctly.</p><p>If we remove the setup related comments from the workflow, we'll have this:</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token atrule key">name</span><span class="token punctuation">:</span> Deploy to Cloud Run from Source
</span><span class="code-line">
</span><span class="code-line"><span class="token atrule key">on</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">push</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">branches</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> main
</span><span class="code-line">
</span><span class="code-line"><span class="token atrule key">env</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">PROJECT_ID</span><span class="token punctuation">:</span> YOUR_PROJECT_ID <span class="token comment"># TODO: update Google Cloud project id</span>
</span><span class="code-line">  <span class="token atrule key">SERVICE</span><span class="token punctuation">:</span> YOUR_SERVICE_NAME <span class="token comment"># TODO: update Cloud Run service name</span>
</span><span class="code-line">  <span class="token atrule key">REGION</span><span class="token punctuation">:</span> YOUR_SERVICE_REGION <span class="token comment"># TODO: update Cloud Run service region</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token atrule key">jobs</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">deploy</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token comment"># Add 'id-token' with the intended permissions for workload identity federation</span>
</span><span class="code-line">    <span class="token atrule key">permissions</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">contents</span><span class="token punctuation">:</span> <span class="token string">'read'</span>
</span><span class="code-line">      <span class="token atrule key">id-token</span><span class="token punctuation">:</span> <span class="token string">'write'</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token atrule key">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
</span><span class="code-line">    <span class="token atrule key">steps</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> Checkout
</span><span class="code-line">        <span class="token atrule key">uses</span><span class="token punctuation">:</span> actions/checkout@v2
</span><span class="code-line">
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> Google Auth
</span><span class="code-line">        <span class="token atrule key">id</span><span class="token punctuation">:</span> auth
</span><span class="code-line">        <span class="token atrule key">uses</span><span class="token punctuation">:</span> <span class="token string">'google-github-actions/auth@v0'</span>
</span><span class="code-line">        <span class="token atrule key">with</span><span class="token punctuation">:</span>
</span><span class="code-line">          <span class="token atrule key">workload_identity_provider</span><span class="token punctuation">:</span> <span class="token string">'${{ secrets.WIF_PROVIDER }}'</span> <span class="token comment"># e.g. - projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider</span>
</span><span class="code-line">          <span class="token atrule key">service_account</span><span class="token punctuation">:</span> <span class="token string">'${{ secrets.WIF_SERVICE_ACCOUNT }}'</span> <span class="token comment"># e.g. - my-service-account@my-project.iam.gserviceaccount.com</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> Deploy to Cloud Run
</span><span class="code-line">        <span class="token atrule key">id</span><span class="token punctuation">:</span> deploy
</span><span class="code-line">        <span class="token atrule key">uses</span><span class="token punctuation">:</span> google<span class="token punctuation">-</span>github<span class="token punctuation">-</span>actions/deploy<span class="token punctuation">-</span>cloudrun@v0
</span><span class="code-line">        <span class="token atrule key">with</span><span class="token punctuation">:</span>
</span><span class="code-line">          <span class="token atrule key">service</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.SERVICE <span class="token punctuation">}</span><span class="token punctuation">}</span>
</span><span class="code-line">          <span class="token atrule key">region</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> env.REGION <span class="token punctuation">}</span><span class="token punctuation">}</span>
</span><span class="code-line">          <span class="token comment"># NOTE: If required, update to the appropriate source folder</span>
</span><span class="code-line">          <span class="token atrule key">source</span><span class="token punctuation">:</span> ./
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment"># If required, use the Cloud Run url output in later steps</span>
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> Show Output
</span><span class="code-line">        <span class="token atrule key">run</span><span class="token punctuation">:</span> echo $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.deploy.outputs.url <span class="token punctuation">}</span><span class="token punctuation">}</span>
</span></code></pre></div><p>So we now just need to take care of the environment variables and secrets.</p><p>For the environment variables:</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token punctuation">---</span>
</span><span class="code-line"><span class="token atrule key">env</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">PROJECT_ID</span><span class="token punctuation">:</span> YOUR_PROJECT_ID <span class="token comment"># TODO: update Google Cloud project id</span>
</span><span class="code-line">  <span class="token atrule key">SERVICE</span><span class="token punctuation">:</span> YOUR_SERVICE_NAME <span class="token comment"># TODO: update Cloud Run service name</span>
</span><span class="code-line">  <span class="token atrule key">REGION</span><span class="token punctuation">:</span> YOUR_SERVICE_REGION <span class="token comment"># TODO: update Cloud Run service region</span>
</span></code></pre></div><p>Update the <code>YOUR_PROJECT_ID</code> to your GCP project ID.</p><p>For the <code>YOUR_SERVICE_NAME</code> and <code>YOUR_SERVICE_REGION</code>, these were defined earlier on in the step where we manually deployed using the gcloud CLI.</p><p>You can easily find these by going to Cloud Run in the GCP console and this info will be available in the table.</p><p>For example:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27248%27/%3e"></span><img alt="Google Cloud Run credentials" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Google Cloud Run credentials" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fcloud-run-creds.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fcloud-run-creds.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/cloud-run-creds.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>So I'll update my env variables to:</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token punctuation">---</span>
</span><span class="code-line"><span class="token atrule key">env</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">PROJECT_ID</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>album<span class="token punctuation">-</span><span class="token number">348214</span>
</span><span class="code-line">  <span class="token atrule key">SERVICE</span><span class="token punctuation">:</span> nest<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>run
</span><span class="code-line">  <span class="token atrule key">REGION</span><span class="token punctuation">:</span> europe<span class="token punctuation">-</span>west1
</span></code></pre></div><p>And the final step is to add the secrets required in the authentication step:</p><div class="relative"><pre><code class="code-highlight language-yml"><span class="code-line"><span class="token punctuation">---</span>
</span><span class="code-line"><span class="token punctuation">-</span> <span class="token atrule key">name</span><span class="token punctuation">:</span> Google Auth
</span><span class="code-line">  <span class="token atrule key">id</span><span class="token punctuation">:</span> auth
</span><span class="code-line">  <span class="token atrule key">uses</span><span class="token punctuation">:</span> <span class="token string">'google-github-actions/auth@v0'</span>
</span><span class="code-line">  <span class="token atrule key">with</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">workload_identity_provider</span><span class="token punctuation">:</span> <span class="token string">'${{ secrets.WIF_PROVIDER }}'</span> <span class="token comment"># e.g. - projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider</span>
</span><span class="code-line">    <span class="token atrule key">service_account</span><span class="token punctuation">:</span> <span class="token string">'${{ secrets.WIF_SERVICE_ACCOUNT }}'</span> <span class="token comment"># e.g. - my-service-account@my-project.iam.gserviceaccount.com</span>
</span></code></pre></div><p>To find the <code>WIF_PROVIDER</code> value, head to Workload Identity Federation in the console and click into the pool you setup earlier:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27669%27/%3e"></span><img alt="Workload Identity Federation pool" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Workload Identity Federation pool" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-pool.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-pool.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-pool.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>On the right hand side in the Providers tab, press the edit icon:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27677%27/%3e"></span><img alt="Edit Workload identity federation provider" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Edit Workload identity federation provider" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider-edit.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider-edit.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-provider-edit.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>Copy the URL shown under Default audience. You just need the string starting from <code>projects/</code> so you can remove <code>https://iam.googleapis.com/</code>.</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27873%27/%3e"></span><img alt="Copy default audience URL" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Copy default audience URL" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider-value.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fworkload-provider-value.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/workload-provider-value.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>To add a Github secret, navigate to the Settings tab in your Github repo and go into Secrets in the left nav:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27684%27/%3e"></span><img alt="Github secrets" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Github secrets" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fgithub-secrets.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fgithub-secrets.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/github-secrets.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>Then press the 'New repository secret' button and add the <code>WIF_PROVIDER</code> value.</p><p>The <code>WIF_SERVICE_ACCOUNT</code> is the email address of the service account you created in the previous step above.</p><p>To find this, head to Service Accounts in the GCP console and you'll see a list of your service accounts. Grab the email address of the service account you created:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27706%27/%3e"></span><img alt="GCP service accounts" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="GCP service accounts" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fservice-account.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/service-account.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>Add this email address as another Github secret for <code>WIF_SERVICE_ACCOUNT</code>.</p><p>In Github, you now just need to commit the Github Acton you've created:</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%271140%27%20height=%27848%27/%3e"></span><img alt="Commit to Github" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"><noscript><img alt="Commit to Github" srcset="/_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fgitub-action-commit.png&amp;w=1200&amp;q=75 1x, /_next/image?url=%2Fstatic%2Fimages%2Fdeploy-nestjs-cloud-run%2Fgitub-action-commit.png&amp;w=3840&amp;q=75 2x" src="./Deploying a NestJS app to Cloud Run with Github Actions_files/gitub-action-commit.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"></noscript></span></div><p>You'll now see the workflow running and deploying to Cloud Run!</p><h2 id="conclusion"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h2><p>Every time you now make a commit to the <code>main</code> branch of your project, it will roll out a new deployment to Cloud Run.</p><p>And that's it! Your NestJS app is now deployed to Cloud Run and will continuously deploy with commits to your <code>main</code> branch.</p><p>Here's a couple of extra resources related to deploying to production that might be helpful:</p><ul><li><a href="https://www.tomray.dev/nestjs-logging">Using the NestJS Logger</a></li><li><a href="https://www.tomray.dev/nestjs-docker-production">How to write a NestJS Dockerfile optimized for production</a></li></ul></div></div><div class="sticky top-0 hidden h-screen pt-6 pb-8 pl-6 lg:block xl:pl-16"><div class="mb-8"><h3 class="mb-2 font-bold">ðŸ“– Table of contents</h3><div class=""><ul><li class="false  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#prerequisites">Prerequisites</a></li><li class="false  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#start-a-nestjs-project">Start a NestJS project</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#configure-a-port-environment-variable">Configure a PORT environment variable</a></li><li class="false  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#prepare-the-docker-image">Prepare the Docker image</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#test-the-container-locally">Test the container locally</a></li><li class="false  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#manually-deploying-to-cloud-run">Manually deploying to Cloud Run</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#check-your-gcloud-cli-project-is-set">Check your gcloud CLI project is set</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#use-gcloud-run-deploy">Use gcloud run deploy</a></li><li class="false  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#automated-deployments-with-github-actions">Automated deployments with Github Actions</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#enable-google-cloud-apis">Enable Google Cloud APIs</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#create-a-service-account-with-permissions">Create a service account with permissions</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#configure-workflow-identity-federation">Configure Workflow Identity Federation</a></li><li class="ml-6 list-disc  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#add-github-action">Add Github Action</a></li><li class="false  text-gray-600 mb-2 text-sm hover:underline hover:opacity-100"><a href="https://www.tomray.dev/deploy-nestjs-cloud-run#conclusion">Conclusion</a></li></ul></div></div><div><h3 class="mb-1 font-bold">ðŸ”¥ Popular (free) NestJS resources:</h3><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-fundamentals-course">NestJS course on fundamentals</a></li><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-unit-testing">Ultimate guide to unit testing in NestJS</a></li><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-caching-redis">How to set up and use NestJS caching</a></li><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-logging">Ultimate guide to logging in NestJS</a></li><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-config">How to set up and use NestJS config</a></li><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-docker-production">Writing a NestJS Dockerfile</a></li><li class="mb-2 text-sm text-gray-600 hover:underline hover:opacity-100"><a href="https://www.tomray.dev/nestjs-docker-compose-postgres">NestJS local dev with Docker Compose</a></li></div></div></div><div class="mx-auto max-w-2xl"><div class="polka my-8 flex flex-col items-center rounded-md p-6 sm:flex-row sm:items-start "><img src="./Deploying a NestJS app to Cloud Run with Github Actions_files/nestjs.png" alt="NestJS logo" class="mt-0 mb-4 h-20 sm:mr-6 sm:h-20"><div><span class="mb-1 inline-block text-xl font-bold dark:text-gray-800">Free NestJS Course</span><span class="flex flex-col dark:text-gray-800">Want to use NestJS to it's full potential and understand how it really works? Check out my free course which covers concepts like Dependency Injection, IoC Containers and more:</span><form class="mt-4 grid w-full max-w-lg grid-cols-8 items-end text-sm"><div class="mb-2 col-span-8 mr-1 sm:col-span-5 sm:mb-0 sm:mr-2"><label class="mb-2 block text-left font-semibold" for="magnet">Your email address</label><input type="email" name="magnet" id="magnet" class="w-full rounded-md text-sm text-gray-800 focus:ring-primary-500" placeholder="e.g. johnsmith@gmail.com" value="" required=""></div><button type="submit" class="rounded-md border border-green-500 bg-green-500 px-4 py-2 font-bold text-white col-span-8 sm:col-span-3 ">Get free course</button></form></div></div></div></div></div></div></article></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var u=Object.create;var i=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var d=a=\u003ei(a,\"__esModule\",{value:!0});var y=(a,c)=\u003e()=\u003e(c||a((c={exports:{}}).exports,c),c.exports),w=(a,c)=\u003e{d(a);for(var l in c)i(a,l,{get:c[l],enumerable:!0})},f=(a,c,l)=\u003e{if(c\u0026\u0026typeof c==\"object\"||typeof c==\"function\")for(let n of N(c))!g.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026i(a,n,{get:()=\u003ec[n],enumerable:!(l=m(c,n))||l.enumerable});return a},v=a=\u003ef(d(i(a!=null?u(k(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var p=y((j,h)=\u003e{h.exports=_jsx_runtime});var R={};w(R,{default:()=\u003eI,frontmatter:()=\u003eb});var e=v(p()),b={title:\"Deploying a NestJS app to Cloud Run with Github Actions\",h1:\"Deploying a NestJS app to Cloud Run with Github Actions\",date:\"2022-05-29\",lastmod:\"2022-05-29\",draft:!1,summary:\"Learn how to deploy a NestJs app with continuous deployments to Cloud Run using Github Actions and Cloud Build\",images:[\"/static/images/deploy-nestjs-cloud-run/nest-cloud-run.png\"]};function C(a={}){let{wrapper:c}=a.components||{};return c?(0,e.jsx)(c,Object.assign({},a,{children:(0,e.jsx)(l,{})})):l();function l(){let n=Object.assign({p:\"p\",a:\"a\",h2:\"h2\",span:\"span\",ul:\"ul\",li:\"li\",pre:\"pre\",code:\"code\",h3:\"h3\",div:\"div\",ol:\"ol\"},a.components),{Magnet:t,TOCInline:r,Image:s}=n;return s||o(\"Image\",!0),t||o(\"Magnet\",!0),r||o(\"TOCInline\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.p,{children:[\"This is a quick start guide to deploying a NestJs project to \",(0,e.jsx)(n.a,{href:\"https://cloud.google.com/run\",children:\"Cloud Run\"}),\".\"]}),(0,e.jsx)(n.p,{children:\"We'll first setup the deployment manually, then move to an automated CD (continuous deployment) workflow using Github Actions.\"}),(0,e.jsx)(n.p,{children:\"Ready? Let's dive in \\u{1F93F}.\"}),(0,e.jsxs)(n.p,{children:[\"Here's the \",(0,e.jsx)(n.a,{href:\"https://github.com/tomwray13/nest-cloud-run\",children:\"Github repository\"}),\" if you'd like to review the code.\"]}),(0,e.jsx)(t,{}),(0,e.jsx)(r,{toc:a.toc,asDisclosure:!0}),(0,e.jsxs)(n.h2,{id:\"prerequisites\",children:[(0,e.jsx)(n.a,{href:\"#prerequisites\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Prerequisites\"]}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"Your Nest project is a Github repository. This allows us to setup continuous deployment with Github Actions.\"}),(0,e.jsx)(n.li,{children:\"Docker installed on your machine\"}),(0,e.jsx)(n.li,{children:\"A project setup in Google Cloud Platform\"}),(0,e.jsxs)(n.li,{children:[\"Have the \",(0,e.jsx)(n.a,{href:\"https://cloud.google.com/sdk/docs/install\",children:\"gcloud CLI\"}),\" installed on your machine\"]})]}),(0,e.jsxs)(n.h2,{id:\"start-a-nestjs-project\",children:[(0,e.jsx)(n.a,{href:\"#start-a-nestjs-project\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Start a NestJS project\"]}),(0,e.jsx)(n.p,{children:\"Incase you don't have a NestJS project setup already, set one up with the Nest CLI:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsxs)(n.code,{className:\"language-shell code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"$ \",(0,e.jsx)(n.span,{className:\"token function\",children:\"npm\"}),` i -g @nestjs/cli\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`$ nest new project-name\n`})]})}),(0,e.jsx)(n.p,{children:\"Follow the prompts to setup your project.\"}),(0,e.jsxs)(n.h3,{id:\"configure-a-port-environment-variable\",children:[(0,e.jsx)(n.a,{href:\"#configure-a-port-environment-variable\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Configure a PORT environment variable\"]}),(0,e.jsxs)(n.p,{children:[\"Cloud Run will automatically inject the \",(0,e.jsx)(n.code,{children:\"PORT\"}),\" number, so you'll need to edit the default bootstrap function which starts the server.\"]}),(0,e.jsx)(n.p,{children:\"Here's the default:\"}),(0,e.jsx)(n.pre,{className:\"language-ts\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-ts\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"async\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"function\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"bootstrap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" app \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"await\"}),\" NestFactory\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"create\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"AppModule\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"await\"}),\" app\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"listen\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"You'll need to update this to the following:\"}),(0,e.jsx)(n.pre,{className:\"language-ts\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-ts\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"async\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"function\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"bootstrap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" app \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"await\"}),\" NestFactory\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"create\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"AppModule\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"await\"}),\" app\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"listen\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"parseInt\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"process\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"env\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token constant\",children:\"PORT\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"||\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"3000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Now locally if you don't have a port variable set in your env file, it will default to 3000.\"}),(0,e.jsxs)(n.p,{children:[\"If, however, you try testing this locally by using a custom \",(0,e.jsx)(n.code,{children:\"PORT\"}),\" environment variable and starting up your local server, you'll notice it doesn't work.\"]}),(0,e.jsxs)(n.p,{children:[\"That's because in order to use environment variables in NestJS you need to make the \",(0,e.jsx)(n.code,{children:\".env\"}),\" file accessible.\"]}),(0,e.jsx)(n.p,{children:'To do that \"the Nest way\", install the required dependency:'}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"npm\"}),` i --save @nestjs/config\n`]})})}),(0,e.jsxs)(n.p,{children:[\"Then use the package in the root \",(0,e.jsx)(n.code,{children:\"AppModule\"}),\":\"]}),(0,e.jsx)(n.div,{className:\"remark-code-title\",children:\"app.module.ts\"}),(0,e.jsx)(n.pre,{className:\"language-ts\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-ts\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"...\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" ConfigModule \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"from\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'@nestjs/config'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token decorator\",children:[(0,e.jsx)(n.span,{className:\"token operator at\",children:\"@\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"Module\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  imports\",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"ConfigModule\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"forRoot\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"...\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"export\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"AppModule\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"You can now set a custom \",(0,e.jsx)(n.code,{children:\"PORT\"}),\" value in your env file and test it locally to check that it's working.\"]}),(0,e.jsxs)(n.p,{children:[\"Cloud Run will take care of the port for you on production, so you don't need to manually set a \",(0,e.jsx)(n.code,{children:\"PORT\"}),\" env variable in your Cloud Run secrets.\"]}),(0,e.jsxs)(n.p,{children:[\"For a more detailed look at working with environment variables in NestJS, check out \",(0,e.jsx)(n.a,{href:\"/nestjs-config\",children:\"this tutorial\"}),\".\"]}),(0,e.jsxs)(n.h2,{id:\"prepare-the-docker-image\",children:[(0,e.jsx)(n.a,{href:\"#prepare-the-docker-image\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Prepare the Docker image\"]}),(0,e.jsx)(n.p,{children:\"In order to deploy to Cloud Run, you need a container image.\"}),(0,e.jsxs)(n.p,{children:[\"A container image is an isolated package of software that includes everything you need to run the code. You can define container images by writing a \",(0,e.jsx)(n.code,{children:\"Dockerfile\"}),\" which provides the instructions on how to build the image.\"]}),(0,e.jsxs)(n.p,{children:[\"This tutorial won't go into the details of \",(0,e.jsx)(n.a,{href:\"/nestjs-docker-production\",children:\"how to write a production optimized Dockerfile for NestJS apps\"}),\", however, here's a Dockerfile set up to achieve just that:\"]}),(0,e.jsx)(n.div,{className:\"remark-code-title\",children:\"Dockerfile\"}),(0,e.jsx)(n.pre,{className:\"language-dockerfile\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-Dockerfile\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"###################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# BUILD FOR LOCAL DEVELOPMENT\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"###################\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"As\"}),\" development\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Create app directory\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /usr/src/app\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Copy application dependency manifests to the container image.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# A wildcard is used to ensure copying both package.json AND package-lock.json (when available).\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Copying this first prevents re-running npm install on every code change.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"})]}),\" package*.json ./\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Install app dependencies using the `npm ci` command instead of `npm install`\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"RUN\"}),\" npm ci\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Bundle app source\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"})]}),\" . .\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Use the node user from the image (instead of the root user)\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"###################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# BUILD FOR PRODUCTION\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"###################\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"As\"}),\" build\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /usr/src/app\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"})]}),\" package*.json ./\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# In order to run `npm run build` we need access to the Nest CLI which is a dev dependency. In the previous development stage we ran `npm ci` which installed all dependencies, so we can copy over the node_modules directory from the development image\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,e.jsx)(n.span,{className:\"token property\",children:\"--from\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"development\"})]}),\" /usr/src/app/node_modules ./node_modules\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"})]}),\" . .\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Run the build command which creates the production bundle\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"RUN\"}),\" npm run build\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Set NODE_ENV environment variable\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV production\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Running `npm ci` removes the existing node_modules directory and passing in --only=production ensures that only the production dependencies are installed. This ensures that the node_modules directory is as optimized as possible\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"RUN\"}),\" npm ci --only=production \u0026\u0026 npm cache clean --force\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"###################\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# PRODUCTION\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"###################\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"As\"}),\" production\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Copy the bundled code from the build stage to the production image\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,e.jsx)(n.span,{className:\"token property\",children:\"--from\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"build\"})]}),\" /usr/src/app/node_modules ./node_modules\"]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,e.jsxs)(n.span,{className:\"token options\",children:[(0,e.jsx)(n.span,{className:\"token property\",children:\"--chown\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,e.jsx)(n.span,{className:\"token property\",children:\"--from\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"build\"})]}),\" /usr/src/app/dist ./dist\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Start the server using the production build\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token instruction\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"CMD\"}),\" [ \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"node\"'}),\", \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"dist/main.js\"'}),\" ]\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`})]})}),(0,e.jsxs)(n.p,{children:[\"Similar to a \",(0,e.jsx)(n.code,{children:\".gitignore\"}),\" file, we can add a \",(0,e.jsx)(n.code,{children:\".dockerignore\"}),\" file which will prevent certain files from being included in the image build.\"]}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"touch\"}),` .dockerignore\n`]})})}),(0,e.jsx)(n.p,{children:\"Then exclude the following files from the image build:\"}),(0,e.jsx)(n.div,{className:\"remark-code-title\",children:\".dockerignore\"}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`Dockerfile\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`.dockerignore\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`node_modules\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`npm-debug.log\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`dist\n`})]})}),(0,e.jsxs)(n.h3,{id:\"test-the-container-locally\",children:[(0,e.jsx)(n.a,{href:\"#test-the-container-locally\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Test the container locally\"]}),(0,e.jsx)(n.p,{children:\"Before pushing this up to Cloud Run, let's now do some testing locally to check if the Dockerfile behaves as we expect.\"}),(0,e.jsxs)(n.p,{children:[\"Let's first build the image using the command in your terminal at the root of your project (you can swap out \",(0,e.jsx)(n.code,{children:\"nest-cloud-run\"}),\" with your project name). Don't forget the \",(0,e.jsx)(n.code,{children:\".\"}),\"!\"]}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"docker\"}),\" build -t nest-cloud-run \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\".\"}),`\n`]})})}),(0,e.jsxs)(n.p,{children:[\"You can verify the image has been created by running \",(0,e.jsx)(n.code,{children:\"docker images\"}),\" which will output a list of Docker images you have on your local machine:\"]}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsxs)(n.code,{className:\"language-shell code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"docker\"}),` images\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`REPOSITORY                   TAG       IMAGE ID       CREATED          SIZE\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"nest-cloud-run               latest    004f7f222139   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"31\"}),` seconds ago   114MB\n`]})]})}),(0,e.jsx)(n.p,{children:\"Let's now start the container and run the image with this command (be sure to same image name used above):\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"docker\"}),` run -p80:3000 nest-cloud-run\n`]})})}),(0,e.jsxs)(n.p,{children:[\"You can now access the NestJS app by visiting \",(0,e.jsx)(n.code,{children:\"http://localhost\"}),\" in your browser (just \",(0,e.jsx)(n.code,{children:\"http://localhost\"}),\" without any port numbers).\"]}),(0,e.jsxs)(n.h2,{id:\"manually-deploying-to-cloud-run\",children:[(0,e.jsx)(n.a,{href:\"#manually-deploying-to-cloud-run\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Manually deploying to Cloud Run\"]}),(0,e.jsx)(n.p,{children:\"Before setting up automated deployments when changes are pushed to your Git repo, let's first do a manual deployment using the gcloud CLI.\"}),(0,e.jsx)(n.p,{children:\"Doing a manual deployment via the gcloud CLI will setup the Cloud Run service for us rather than needing to manually create inside the GCP console.\"}),(0,e.jsxs)(n.h3,{id:\"check-your-gcloud-cli-project-is-set\",children:[(0,e.jsx)(n.a,{href:\"#check-your-gcloud-cli-project-is-set\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Check your gcloud CLI project is set\"]}),(0,e.jsx)(n.p,{children:\"You might have multiple accounts and projects in your GCP account, so you'll want to make sure you create the Cloud Run service in the right one.\"}),(0,e.jsx)(n.p,{children:\"First you can check the current active project the gcloud CLI is using by running:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`gcloud config get-value project\n`})})}),(0,e.jsx)(n.p,{children:\"If that command returns the ID of the project you want to create the Cloud Run service in, great! Skip down to the next section. Otherwise, follow the next steps:\"}),(0,e.jsx)(n.p,{children:\"Make sure you're authenticated into the correct account:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsxs)(n.code,{className:\"language-shell code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`gcloud auth list\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"* account \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  account \",(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"You need to be authenticated in the account where your project lives, so change account if necessary with:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gcloud config \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"set\"}),\" account \",(0,e.jsxs)(n.span,{className:\"token variable\",children:[(0,e.jsx)(n.span,{className:\"token variable\",children:\"`\"}),\"ACCOUNT\",(0,e.jsx)(n.span,{className:\"token variable\",children:\"`\"})]}),`\n`]})})}),(0,e.jsx)(n.p,{children:\"List out the projects in the account your authenticated in:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`gcloud projects list\n`})})}),(0,e.jsx)(n.p,{children:\"And finally, switch to the intended project:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"gcloud config \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"set\"}),\" project \",(0,e.jsxs)(n.span,{className:\"token variable\",children:[(0,e.jsx)(n.span,{className:\"token variable\",children:\"`\"}),\"PROJECT ID\",(0,e.jsx)(n.span,{className:\"token variable\",children:\"`\"})]}),`\n`]})})}),(0,e.jsxs)(n.h3,{id:\"use-gcloud-run-deploy\",children:[(0,e.jsx)(n.a,{href:\"#use-gcloud-run-deploy\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Use gcloud run deploy\"]}),(0,e.jsxs)(n.p,{children:[\"We're now going to use the \",(0,e.jsx)(n.code,{children:\"gcloud run deploy\"}),\" command which feels a bit like magic - so let's breakdown what happens behind the scenes:\"]}),(0,e.jsxs)(n.ul,{children:[(0,e.jsxs)(n.li,{children:[\"Uses Cloud Build to build the container image (using the \",(0,e.jsx)(n.code,{children:\"Dockerfile\"}),\" as instructions)\"]}),(0,e.jsx)(n.li,{children:\"The container is stored in Artifact Registry\"}),(0,e.jsx)(n.li,{children:\"Creates a service in Cloud Run against the container image\"})]}),(0,e.jsxs)(n.p,{children:[\"For this step, you can either follow the \",(0,e.jsx)(n.a,{href:\"https://cloud.google.com/run/docs/quickstarts/build-and-deploy/deploy-nodejs-service\",children:\"Cloud Run docs\"}),\" (recommended) or follow the steps below.\"]}),(0,e.jsx)(n.p,{children:\"Run the following command in your terminal at the root of your project:\"}),(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsx)(n.span,{className:\"code-line\",children:`gcloud run deploy\n`})})}),(0,e.jsxs)(n.p,{children:[\"If prompted to enable the API, Reply \",(0,e.jsx)(n.code,{children:\"y\"}),\" to enable.\"]}),(0,e.jsxs)(n.ol,{children:[(0,e.jsx)(n.li,{children:\"When you are prompted for the source code location, press Enter to deploy the current folder.\"}),(0,e.jsx)(n.li,{children:\"When you are prompted for the service name, press Enter to accept the default name.\"}),(0,e.jsx)(n.li,{children:\"If you are prompted to enable the Artifact Registry API, respond by pressing y.\"}),(0,e.jsx)(n.li,{children:\"When you are prompted for region: select the region of your choice, for example, us-central1.\"}),(0,e.jsx)(n.li,{children:\"You will be prompted to allow unauthenticated invocations: respond y .\"})]}),(0,e.jsx)(n.p,{children:\"Then wait a few moments until the deployment is complete. On success, the command line displays the service URL.\"}),(0,e.jsx)(n.p,{children:\"Visit your deployed service by opening the service URL in a web browser.\"}),(0,e.jsx)(t,{}),(0,e.jsxs)(n.h2,{id:\"automated-deployments-with-github-actions\",children:[(0,e.jsx)(n.a,{href:\"#automated-deployments-with-github-actions\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Automated deployments with Github Actions\"]}),(0,e.jsx)(n.p,{children:\"Okay, let's setup some automation with Github Actions!\"}),(0,e.jsxs)(n.h3,{id:\"enable-google-cloud-apis\",children:[(0,e.jsx)(n.a,{href:\"#enable-google-cloud-apis\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Enable Google Cloud APIs\"]}),(0,e.jsx)(n.p,{children:\"Before proceeding, make sure the following are enabled inside your Google Cloud Platform account:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://console.cloud.google.com/marketplace/product/google/run.googleapis.com\",children:\"Cloud Run API\"})}),(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://console.cloud.google.com/marketplace/product/google/cloudbuild.googleapis.com\",children:\"Cloud Build API\"})}),(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"https://console.cloud.google.com/marketplace/product/google/artifactregistry.googleapis.com\",children:\"Artifact Registry API\"})})]}),(0,e.jsx)(n.p,{children:\"Just click the above 3 links and ensure you've pressed the 'Enable' button on each.\"}),(0,e.jsxs)(n.h3,{id:\"create-a-service-account-with-permissions\",children:[(0,e.jsx)(n.a,{href:\"#create-a-service-account-with-permissions\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Create a service account with permissions\"]}),(0,e.jsx)(n.p,{children:\"We're going to do the next couple of steps inside the GCP console rather than via the gcloud CLI - I'm a more visual dude so that's what I prefer!\"}),(0,e.jsx)(n.p,{children:\"As we're setting up the deployments to Cloud Run in a 3rd party environment (Github), we need a way of giving access to Github to run the deployment.\"}),(0,e.jsx)(n.p,{children:\"That's where service accounts come in.\"}),(0,e.jsx)(n.p,{children:\"A service account allows 'non-human' users to interact with Google APIs - exactly what we need to work with Github.\"}),(0,e.jsx)(n.p,{children:\"So if you first go to create a service account:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Create service account\",src:\"/static/images/deploy-nestjs-cloud-run/create-service-account.png\",width:\"1140\",height:\"620\"})}),(0,e.jsx)(n.p,{children:\"And then add the service account details (something like 'Github Action' makes sense):\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Service account name\",src:\"/static/images/deploy-nestjs-cloud-run/service-account-name.png\",width:\"1140\",height:\"636\"})}),(0,e.jsx)(n.p,{children:\"Then in the next step. grant the following roles:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"Cloud Run Admin\"}),(0,e.jsx)(n.li,{children:\"Cloud Run Service Agent\"}),(0,e.jsx)(n.li,{children:\"Cloud Build Editor\"}),(0,e.jsx)(n.li,{children:\"Storage Admin\"}),(0,e.jsx)(n.li,{children:\"Artifact Registry Administrator\"})]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Service account permissions\",src:\"/static/images/deploy-nestjs-cloud-run/service-account-permissions.png\",width:\"1140\",height:\"854\"})}),(0,e.jsx)(n.p,{children:\"You can skip the final step where it prompts you to grant users access to this service account.\"}),(0,e.jsxs)(n.h3,{id:\"configure-workflow-identity-federation\",children:[(0,e.jsx)(n.a,{href:\"#configure-workflow-identity-federation\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Configure Workflow Identity Federation\"]}),(0,e.jsx)(n.p,{children:\"The Github Action we're going to setup in the next step has essentially 2 steps:\"}),(0,e.jsxs)(n.ol,{children:[(0,e.jsx)(n.li,{children:\"Authenticate the service account to make deployments to your Cloud Run project\"}),(0,e.jsx)(n.li,{children:\"Deploy your application to Cloud Run (this step takes care of building the image, too)\"})]}),(0,e.jsx)(n.p,{children:\"For the authentication step, you can either use Workflow Identity or use a credentials JSON file. Google recommends Workflow Identity so that's what we're going to setup now.\"}),(0,e.jsx)(n.p,{children:\"Head to Workload Identity Federation and press the 'Create Pool' button:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Create workload identity pool\",src:\"/static/images/deploy-nestjs-cloud-run/create-workload-pool.png\",width:\"1140\",height:\"706\"})}),(0,e.jsx)(n.p,{children:\"Give your identity pool a name like 'Github Auth':\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Workload identity name\",src:\"/static/images/deploy-nestjs-cloud-run/workload-pool-name.png\",width:\"1140\",height:\"817\"})}),(0,e.jsx)(n.p,{children:\"In the next step for adding a provider to pool, set the following:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"Choose OpenID Connect (OIDC) in the 'Select a provider' dropdown\"}),(0,e.jsx)(n.li,{children:\"Define a provider name (e.g. Github Action)\"}),(0,e.jsx)(n.li,{children:\"Define a provider ID (e.g. github-action). This might be set automatically for you.\"}),(0,e.jsxs)(n.li,{children:[\"For the issuer URL, use \",(0,e.jsx)(n.code,{children:\"https://token.actions.githubusercontent.com\"})]}),(0,e.jsx)(n.li,{children:\"Leave the audience set to 'Default audience'\"})]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Add workload identity provider\",src:\"/static/images/deploy-nestjs-cloud-run/workload-provider.png\",width:\"1140\",height:\"906\"})}),(0,e.jsx)(n.p,{children:\"In the next step, add the following 3 provider attributes:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsxs)(n.li,{children:[\"google-subject = \",(0,e.jsx)(n.code,{children:\"assertion.sub\"})]}),(0,e.jsxs)(n.li,{children:[\"attribute.actor = \",(0,e.jsx)(n.code,{children:\"assertion.actor\"})]}),(0,e.jsxs)(n.li,{children:[\"attribute.repository = \",(0,e.jsx)(n.code,{children:\"assertion.repository\"})]})]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Set workload identity provider attributes\",src:\"/static/images/deploy-nestjs-cloud-run/workload-provider-attributes.png\",width:\"1140\",height:\"891\"})}),(0,e.jsx)(n.p,{children:\"Then hit the save button.\"}),(0,e.jsx)(n.p,{children:\"Copy the IAM principal value of the pool to your clipboard. We'll need this in an upcoming step.\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"IAM principal value\",src:\"/static/images/deploy-nestjs-cloud-run/workload-pool-id.png\",width:\"1440\",height:\"966\"})}),(0,e.jsx)(n.p,{children:\"The final step is to connect the service account we created in the previous step to the Pool we just created.\"}),(0,e.jsx)(n.p,{children:\"To do that, head to the Service Accounts page and go into the service account you created in the previous step:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"List of GCP service accounts\",src:\"/static/images/deploy-nestjs-cloud-run/service-account.png\",width:\"1140\",height:\"706\"})}),(0,e.jsx)(n.p,{children:\"From there, go into the Permissions tab and press the 'Grant Access' button to add a new principal with a role-specific to our pool.\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Grant new IAM principal\",src:\"/static/images/deploy-nestjs-cloud-run/service-account-add-permissions.png\",width:\"1140\",height:\"771\"})}),(0,e.jsx)(n.p,{children:\"For the 'New principal' field, you'll want to append 2 strings together:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"The IAM principal value you copied to your clipboard above\"}),(0,e.jsxs)(n.li,{children:[\"And \",(0,e.jsx)(n.code,{children:\"/attribute.repository/${REPO}\"}),\" (You'll want to replace \",(0,e.jsx)(n.code,{children:\"${REPO}\"}),\" with your Github repo using the format \",(0,e.jsx)(n.code,{children:\"username/repo\"}),\". For example, mine would be \",(0,e.jsx)(n.code,{children:\"tomwray13/nest-cloud-run\"}),\")\"]})]}),(0,e.jsx)(n.p,{children:\"Together, mine looks like this:\"}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"principalSet://iam.googleapis.com/projects/84230984908/locations/global/workloadIdentityPools/github-auth/attribute.repository/tomwray13/nest-cloud-run\"})}),(0,e.jsx)(n.p,{children:\"Use this string in the 'New principal' field and set the role as Workload Identity User:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Add new IAM principal\",src:\"/static/images/deploy-nestjs-cloud-run/service-account-add-principal.png\",width:\"1140\",height:\"755\"})}),(0,e.jsx)(n.p,{children:\"And that's it! Now to building our Github Action.\"}),(0,e.jsxs)(n.h3,{id:\"add-github-action\",children:[(0,e.jsx)(n.a,{href:\"#add-github-action\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Add Github Action\"]}),(0,e.jsxs)(n.p,{children:[\"Let's first go to the 'Actions' tab in your Github repo and search for \",(0,e.jsx)(n.code,{children:\"cloud run\"}),\". Press the configure button on the 'Deploy to Cloud Run from source' workflow:\"]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Github Action search\",src:\"/static/images/deploy-nestjs-cloud-run/github-actions-cloud-run.png\",width:\"1140\",height:\"644\"})}),(0,e.jsx)(n.p,{children:\"This is the official workflow written by the GCP team and what we'll be using to build our Github Action.\"}),(0,e.jsx)(n.p,{children:\"There are some helpful comments in the workflow which explain the setup required. We've already covered this setup in the previous steps, but it's worth reading to ensure everything is setup correctly.\"}),(0,e.jsx)(n.p,{children:\"If we remove the setup related comments from the workflow, we'll have this:\"}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Deploy to Cloud Run from Source\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"on\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"push\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"branches\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` main\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"env\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"PROJECT_ID\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" YOUR_PROJECT_ID \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# TODO: update Google Cloud project id\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"SERVICE\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" YOUR_SERVICE_NAME \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# TODO: update Cloud Run service name\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"REGION\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" YOUR_SERVICE_REGION \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# TODO: update Cloud Run service region\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"jobs\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"deploy\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Add 'id-token' with the intended permissions for workload identity federation\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"permissions\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"contents\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'read'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"id-token\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'write'\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"runs-on\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" ubuntu\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`latest\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"steps\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Checkout\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"uses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` actions/checkout@v2\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Google Auth\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"id\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` auth\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"uses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'google-github-actions/auth@v0'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"with\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"workload_identity_provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'${{ secrets.WIF_PROVIDER }}'\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# e.g. - projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"service_account\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'${{ secrets.WIF_SERVICE_ACCOUNT }}'\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# e.g. - my-service-account@my-project.iam.gserviceaccount.com\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Deploy to Cloud Run\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"id\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` deploy\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"uses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" google\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"github\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"actions/deploy\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`cloudrun@v0\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"with\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"service\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" $\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" env.SERVICE \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"region\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" $\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" env.REGION \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# NOTE: If required, update to the appropriate source folder\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"source\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` ./\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# If required, use the Cloud Run url output in later steps\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Show Output\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"run\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" echo $\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\" steps.deploy.outputs.url \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"So we now just need to take care of the environment variables and secrets.\"}),(0,e.jsx)(n.p,{children:\"For the environment variables:\"}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"---\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"env\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"PROJECT_ID\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" YOUR_PROJECT_ID \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# TODO: update Google Cloud project id\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"SERVICE\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" YOUR_SERVICE_NAME \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# TODO: update Cloud Run service name\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"REGION\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" YOUR_SERVICE_REGION \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# TODO: update Cloud Run service region\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"Update the \",(0,e.jsx)(n.code,{children:\"YOUR_PROJECT_ID\"}),\" to your GCP project ID.\"]}),(0,e.jsxs)(n.p,{children:[\"For the \",(0,e.jsx)(n.code,{children:\"YOUR_SERVICE_NAME\"}),\" and \",(0,e.jsx)(n.code,{children:\"YOUR_SERVICE_REGION\"}),\", these were defined earlier on in the step where we manually deployed using the gcloud CLI.\"]}),(0,e.jsx)(n.p,{children:\"You can easily find these by going to Cloud Run in the GCP console and this info will be available in the table.\"}),(0,e.jsx)(n.p,{children:\"For example:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Google Cloud Run credentials\",src:\"/static/images/deploy-nestjs-cloud-run/cloud-run-creds.png\",width:\"1140\",height:\"248\"})}),(0,e.jsx)(n.p,{children:\"So I'll update my env variables to:\"}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"---\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"env\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"PROJECT_ID\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" direct\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"album\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"348214\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"SERVICE\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" nest\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"cloud\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`run\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"REGION\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" europe\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`west1\n`]})]})}),(0,e.jsx)(n.p,{children:\"And the final step is to add the secrets required in the authentication step:\"}),(0,e.jsx)(n.pre,{className:\"language-yml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"---\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` Google Auth\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"id\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` auth\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"uses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'google-github-actions/auth@v0'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"with\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"workload_identity_provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'${{ secrets.WIF_PROVIDER }}'\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# e.g. - projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"service_account\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'${{ secrets.WIF_SERVICE_ACCOUNT }}'\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# e.g. - my-service-account@my-project.iam.gserviceaccount.com\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"To find the \",(0,e.jsx)(n.code,{children:\"WIF_PROVIDER\"}),\" value, head to Workload Identity Federation in the console and click into the pool you setup earlier:\"]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Workload Identity Federation pool\",src:\"/static/images/deploy-nestjs-cloud-run/workload-pool.png\",width:\"1140\",height:\"669\"})}),(0,e.jsx)(n.p,{children:\"On the right hand side in the Providers tab, press the edit icon:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Edit Workload identity federation provider\",src:\"/static/images/deploy-nestjs-cloud-run/workload-provider-edit.png\",width:\"1140\",height:\"677\"})}),(0,e.jsxs)(n.p,{children:[\"Copy the URL shown under Default audience. You just need the string starting from \",(0,e.jsx)(n.code,{children:\"projects/\"}),\" so you can remove \",(0,e.jsx)(n.code,{children:\"https://iam.googleapis.com/\"}),\".\"]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Copy default audience URL\",src:\"/static/images/deploy-nestjs-cloud-run/workload-provider-value.png\",width:\"1140\",height:\"873\"})}),(0,e.jsx)(n.p,{children:\"To add a Github secret, navigate to the Settings tab in your Github repo and go into Secrets in the left nav:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Github secrets\",src:\"/static/images/deploy-nestjs-cloud-run/github-secrets.png\",width:\"1140\",height:\"684\"})}),(0,e.jsxs)(n.p,{children:[\"Then press the 'New repository secret' button and add the \",(0,e.jsx)(n.code,{children:\"WIF_PROVIDER\"}),\" value.\"]}),(0,e.jsxs)(n.p,{children:[\"The \",(0,e.jsx)(n.code,{children:\"WIF_SERVICE_ACCOUNT\"}),\" is the email address of the service account you created in the previous step above.\"]}),(0,e.jsx)(n.p,{children:\"To find this, head to Service Accounts in the GCP console and you'll see a list of your service accounts. Grab the email address of the service account you created:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"GCP service accounts\",src:\"/static/images/deploy-nestjs-cloud-run/service-account.png\",width:\"1140\",height:\"706\"})}),(0,e.jsxs)(n.p,{children:[\"Add this email address as another Github secret for \",(0,e.jsx)(n.code,{children:\"WIF_SERVICE_ACCOUNT\"}),\".\"]}),(0,e.jsx)(n.p,{children:\"In Github, you now just need to commit the Github Acton you've created:\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(s,{alt:\"Commit to Github\",src:\"/static/images/deploy-nestjs-cloud-run/gitub-action-commit.png\",width:\"1140\",height:\"848\"})}),(0,e.jsx)(n.p,{children:\"You'll now see the workflow running and deploying to Cloud Run!\"}),(0,e.jsxs)(n.h2,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{href:\"#conclusion\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),(0,e.jsxs)(n.p,{children:[\"Every time you now make a commit to the \",(0,e.jsx)(n.code,{children:\"main\"}),\" branch of your project, it will roll out a new deployment to Cloud Run.\"]}),(0,e.jsxs)(n.p,{children:[\"And that's it! Your NestJS app is now deployed to Cloud Run and will continuously deploy with commits to your \",(0,e.jsx)(n.code,{children:\"main\"}),\" branch.\"]}),(0,e.jsx)(n.p,{children:\"Here's a couple of extra resources related to deploying to production that might be helpful:\"}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"/nestjs-logging\",children:\"Using the NestJS Logger\"})}),(0,e.jsx)(n.li,{children:(0,e.jsx)(n.a,{href:\"/nestjs-docker-production\",children:\"How to write a NestJS Dockerfile optimized for production\"})})]})]})}}var I=C;function o(a,c){throw new Error(\"Expected \"+(c?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return R;})();\n;return Component;","toc":[{"value":"Prerequisites","url":"#prerequisites","depth":2},{"value":"Start a NestJS project","url":"#start-a-nestjs-project","depth":2},{"value":"Configure a PORT environment variable","url":"#configure-a-port-environment-variable","depth":3},{"value":"Prepare the Docker image","url":"#prepare-the-docker-image","depth":2},{"value":"Test the container locally","url":"#test-the-container-locally","depth":3},{"value":"Manually deploying to Cloud Run","url":"#manually-deploying-to-cloud-run","depth":2},{"value":"Check your gcloud CLI project is set","url":"#check-your-gcloud-cli-project-is-set","depth":3},{"value":"Use gcloud run deploy","url":"#use-gcloud-run-deploy","depth":3},{"value":"Automated deployments with Github Actions","url":"#automated-deployments-with-github-actions","depth":2},{"value":"Enable Google Cloud APIs","url":"#enable-google-cloud-apis","depth":3},{"value":"Create a service account with permissions","url":"#create-a-service-account-with-permissions","depth":3},{"value":"Configure Workflow Identity Federation","url":"#configure-workflow-identity-federation","depth":3},{"value":"Add Github Action","url":"#add-github-action","depth":3},{"value":"Conclusion","url":"#conclusion","depth":2}],"frontMatter":{"readingTime":{"text":"15 min read","minutes":14.86,"time":891600,"words":2972},"slug":"deploy-nestjs-cloud-run","fileName":"deploy-nestjs-cloud-run.mdx","title":"Deploying a NestJS app to Cloud Run with Github Actions","h1":"Deploying a NestJS app to Cloud Run with Github Actions","date":"2022-05-29T00:00:00.000Z","lastmod":"2022-05-29","draft":false,"summary":"Learn how to deploy a NestJs app with continuous deployments to Cloud Run using Github Actions and Cloud Build","images":["/static/images/deploy-nestjs-cloud-run/nest-cloud-run.png"]}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.61,"time":36600,"words":122},"slug":["default"],"fileName":"default.md","name":"Tails Azimuth","avatar":"/static/images/avatar.png","occupation":"Professor of Atmospheric Science","company":"Stanford University","email":"address@yoursite.com","twitter":"https://twitter.com/Twitter","linkedin":"https://www.linkedin.com","github":"https://github.com","date":null}],"prev":{"title":"File Uploads with GraphQL, Google Cloud Storage and Node.js","h1":"Uploading files to Google Cloud Storage with an Express GraphQL server","date":"2021-09-07T00:00:00.000Z","lastmod":"2021-09-07","draft":false,"summary":"Learn how to configure a GraphQL Express server to handle multipart requests and upload files to Google Cloud Storage","images":["/static/images/google-cloud-file-uploads/google-cloud-file-uploads.png"],"slug":"google-cloud-file-uploads"},"next":{"title":"NestJS + Redis + Postgres Local Development With Docker Compose","h1":"NestJS, Redis and Postgres local development with Docker Compose","date":"2022-06-12T00:00:00.000Z","lastmod":"2022-06-12","draft":false,"summary":"Learn how to write a docker-compose file that creates a local environment with hot reloading for NestJS, Postgres and Redis (using Prisma as the ORM layer)","images":["/static/images/nestjs-docker-compose-postgres/nest-docker-compose.png"],"slug":"nestjs-docker-compose-postgres"}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["deploy-nestjs-cloud-run"]},"buildId":"gY1_WXfZMqFgi8v7dlJP-","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>